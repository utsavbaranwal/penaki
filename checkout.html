<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Penaki Luxury</title>
    <link rel="stylesheet" href="css/penaki.css">
    <link rel="stylesheet" href="css/checkout.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400;700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q1HRQZ4EBY"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-Q1HRQZ4EBY');
    </script>
</head>
<body>

    <header>
        <a href="index.html" class="logo-text"><img src="img/penaki.png" alt="Penaki Luxury Logo"></a>
        <a href="index.html" class="logo-icon">
            <img src="img/texture logo.png" alt="Penaki Luxury Logo" width="80" height="80">
        </a>
        <nav>
            <a href="products.html">Products</a>
            <a href="index.html#about">About</a>
            <a href="index.html#how-we-work">How We Work</a>
            <a href="index.html#contact">Contact</a>
            <a href="checkout.html">My Cart</a>
        </nav>
        <button class="hamburger-menu" aria-label="Open menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <main class="checkout-container">
        <h1>Cart</h1>
        <div class="checkout-layout">
            <div class="customer-details">
                <h2>Shipping Information</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="contact">Contact No.</label>
                            <input type="tel" id="contact" name="contact" required>
                        </div>
                    </div>
                    
                    <h3>Address</h3>
                    <div class="form-group">
                        <label for="houseNo">House No. / Apartment</label>
                        <input type="text" id="houseNo" name="houseNo" required>
                    </div>
                    <div class="form-group">
                        <label for="locality">Locality</label>
                        <input type="text" id="locality" name="locality" required>
                    </div>
                    <div class="address-grid">
                          <div class="form-group">
                            <label for="pincode">Pincode</label>
                            <input type="tel" id="pincode" name="pincode" required maxlength="6" pattern="\d{6}">
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="order-summary">
                <h2>Order Summary</h2>
                <div id="cartItemsContainer">
                    <!-- Cart items will be injected here by JS -->
                </div>
                <div class="summary-totals">
                    <div class="summary-line">
                        <span>Subtotal</span>
                        <span id="summarySubtotal">₹0</span>
                    </div>
                    <div class="summary-line">
                        <span>Delivery & Handling</span>
                        <span id="summaryDelivery">₹1,995</span>
                    </div>
                    <hr>
                    <div class="summary-line total">
                        <span>Total</span>
                        <span id="summaryTotal">₹0</span>
                    </div>
                </div>
                <button type="submit" form="checkoutForm" class="proceed-btn">Place Order</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            const summarySubtotalEl = document.getElementById('summarySubtotal');
            const summaryDeliveryEl = document.getElementById('summaryDelivery');
            const summaryTotalEl = document.getElementById('summaryTotal');

            function formatCurrency(num) {
                return '₹' + num.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }

            function loadCart() {
                const cart = JSON.parse(localStorage.getItem('carCart')) || [];
                cartItemsContainer.innerHTML = ''; // Clear existing items

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                    updateTotals(0);
                    return;
                }

                let subtotal = 0;
                cart.forEach(item => {
                    const itemTotal = (item.unitPrice || 0) * (item.quantity || 1);
                    subtotal += itemTotal;

                    // Robustly calculate price breakdown
                    const unitPrice = item.unitPrice || 0;
                    const basePrice = item.basePrice || 0;
                    const equipmentPrice = item.equipmentPrice || 0;
                    const bespokePrice = Math.round(unitPrice - basePrice - equipmentPrice);


                    let equipmentHtml = '';
                    if (equipmentPrice > 0) {
                        equipmentHtml = `<div class="breakdown-line">
                            <span>Equipment</span>
                            <span>${formatCurrency(equipmentPrice)}</span>
                        </div>`;
                    }

                    let bespokeHtml = '';
                    if (bespokePrice > 0) {
                        bespokeHtml = `<div class="breakdown-line">
                            <span>Bespoke Colour</span>
                            <span>${formatCurrency(bespokePrice)}</span>
                        </div>`;
                    }

                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-item');
                    itemElement.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <p class="item-name">${item.name}</p>
                            <p class="item-spec">Color: ${item.color}</p>
                            <div class="quantity-selector" data-id="${item.id}">
                                <button class="quantity-btn minus-btn">-</button>
                                <span class="quantity-value">${item.quantity || 1}</span>
                                <button class="quantity-btn plus-btn">+</button>
                            </div>
                        </div>
                        <div class="cart-item-price-breakdown">
                            <div class="breakdown-line">
                                <span>Base Price</span>
                                <span>${formatCurrency(basePrice)}</span>
                            </div>
                            ${equipmentHtml}
                            ${bespokeHtml}
                            <hr class="breakdown-divider">
                            <div class="breakdown-line item-total">
                                <span>Item Total</span>
                                <span>${formatCurrency(itemTotal)}</span>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });

                updateTotals(subtotal);
            }

            function updateQuantity(itemId, change) {
                let cart = JSON.parse(localStorage.getItem('carCart')) || [];
                const itemIndex = cart.findIndex(item => item.id == itemId);

                if (itemIndex > -1) {
                    const newQuantity = cart[itemIndex].quantity + change;

                    if (newQuantity <= 0) {
                        // Remove item if quantity is 0 or less
                        cart.splice(itemIndex, 1);
                    } else {
                        cart[itemIndex].quantity = newQuantity;
                    }

                    localStorage.setItem('carCart', JSON.stringify(cart));
                    loadCart(); // Reload the cart to reflect changes
                }
            }

            function updateTotals(subtotal) {
                const deliveryFee = 1995; // Hardcoded for now
                const total = subtotal + deliveryFee;

                summarySubtotalEl.textContent = formatCurrency(subtotal);
                summaryDeliveryEl.textContent = formatCurrency(deliveryFee);
                summaryTotalEl.textContent = formatCurrency(total);
            }

            loadCart();
            
            document.getElementById('pincode').addEventListener('input', async function() {
                const pincode = this.value;
                const cityInput = document.getElementById('city');
                const stateInput = document.getElementById('state');

                if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
                    try {
                        const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                        const data = await response.json();

                        if (data && data[0].Status === 'Success') {
                            const postOffice = data[0].PostOffice[0];
                            cityInput.value = postOffice.District; // Using District for City
                            stateInput.value = postOffice.State;
                        } else {
                            cityInput.value = '';
                            stateInput.value = '';
                           // alert('Pincode not found. Please check the number or enter details manually.');
                        }
                    } catch (error) {
                        console.error('Failed to fetch pincode data:', error);
                        alert('Could not retrieve address for the pincode. Please enter details manually.');
                    }
                } else {
                    cityInput.value = '';
                    stateInput.value = '';
                }
            });

            cartItemsContainer.addEventListener('click', function(e) {
                const target = e.target;
                const container = target.closest('.quantity-selector');
                if (!container) return;

                const itemId = container.dataset.id;

                if (target.classList.contains('plus-btn')) {
                    updateQuantity(itemId, 1);
                } else if (target.classList.contains('minus-btn')) {
                    updateQuantity(itemId, -1);
                }
            });

            document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const proceedBtn = document.querySelector('.proceed-btn');
                proceedBtn.disabled = true;
                proceedBtn.textContent = 'Processing...';

                const cart = JSON.parse(localStorage.getItem('carCart')) || [];
                if (cart.length === 0) {
                    alert('Your cart is empty.');
                    proceedBtn.disabled = false;
                    proceedBtn.textContent = 'Place Order';
                    return;
                }

                const formData = new FormData(this);
                const subtotal = parseFloat(document.getElementById('summarySubtotal').textContent.replace(/[^0-9.-]+/g,""));
                const deliveryFee = parseFloat(document.getElementById('summaryDelivery').textContent.replace(/[^0-9.-]+/g,""));
                const total = parseFloat(document.getElementById('summaryTotal').textContent.replace(/[^0-9.-]+/g,""));

                const itemsWithPriceBreakdown = cart.map(item => {
                    const unitPrice = item.unitPrice || 0;
                    const basePrice = item.basePrice || 0;
                    const equipmentPrice = item.equipmentPrice || 0;
                    const bespokePrice = Math.round(unitPrice - basePrice - equipmentPrice);
                    return { ...item, basePrice, equipmentPrice, bespokePrice };
                });

                const orderData = {
                    customer: {
                        name: formData.get('name'),
                        email: formData.get('email'),
                        contact: formData.get('contact'),
                    },
                    shippingAddress: {
                        houseNo: formData.get('houseNo'),
                        locality: formData.get('locality'),
                        pincode: formData.get('pincode'),
                        city: formData.get('city'),
                        state: formData.get('state'),
                    },
                    items: itemsWithPriceBreakdown,
                    subtotal,
                    deliveryFee,
                    total
                };

                try {
                    // Step 1: Create a Razorpay Order from your server
                    const createOrderResponse = await fetch('/api/orders/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ amount: orderData.total }),
                    });

                    if (!createOrderResponse.ok) {
                        throw new Error('Failed to create Razorpay order.');
                    }

                    const razorpayOrder = await createOrderResponse.json();

                    // Step 2: Open Razorpay Checkout
                    const options = {
                        "key": "rzp_test_RcMCYcTMFpd2L8", // Your Public Key ID
                        "amount": razorpayOrder.amount,
                        "currency": "INR",
                        "name": "Penaki Luxury",
                        "description": "Vehicle Model Purchase",
                        "image": "img/texture logo.png",
                        "order_id": razorpayOrder.id,
                        "handler": async function (response){
                            // Step 3: Verify the payment and place the order
                            try {
                                const verifyResponse = await fetch('/api/orders/verify', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        razorpayPaymentId: response.razorpay_payment_id,
                                        razorpayOrderId: response.razorpay_order_id,
                                        razorpaySignature: response.razorpay_signature,
                                        orderData: orderData
                                    }),
                                });

                                if (verifyResponse.ok) {
                                    alert('Order placed successfully!');
                                    localStorage.removeItem('carCart');
                                    window.location.href = 'index.html';
                                } else {
                                    const errorData = await verifyResponse.json();
                                    alert(`Failed to place order: ${errorData.message || 'Verification failed'}`);
                                }
                            } catch (error) {
                                console.error('Verification Error:', error);
                                alert('An error occurred during payment verification. Please contact support.');
                            } finally {
                                proceedBtn.disabled = false;
                                proceedBtn.textContent = 'Place Order';
                            }
                        },
                        "prefill": {
                            "name": orderData.customer.name,
                            "email": orderData.customer.email,
                            "contact": orderData.customer.contact
                        },
                        "notes": {
                            "address": `${orderData.shippingAddress.houseNo}, ${orderData.shippingAddress.locality}`
                        },
                        "theme": {
                            "color": "#1f1f1f"
                        }
                    };
                    
                    const rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', function (response){
                        alert("Payment Failed: " + response.error.description);
                        proceedBtn.disabled = false;
                        proceedBtn.textContent = 'Place Order';
                    });

                    rzp1.open();

                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while initiating the payment. Please try again.');
                    proceedBtn.disabled = false;
                    proceedBtn.textContent = 'Place Order';
                }
            });
        });
    </script>
    <script src="penaki.js"></script>

</body>
</html>